<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FUSION Agenda Upload</title>
  <style>
    :root {
      --deep-blue: #182126;
      --white: #FFFFFF;
      --orange: #FA4616;
      --teal: #0BA2B3;
      --deep-blue-2: #2D373C;
      --muted: #A0AAB9;
      --success: #10B981;
      --error: #EF4444;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background: var(--deep-blue);
      color: var(--white);
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-weight: 800;
      font-size: 2rem;
      margin: 0 0 8px 0;
      letter-spacing: -0.02em;
    }
    
    .header p {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    .upload-area {
      border: 2px dashed #3C464B;
      border-radius: 16px;
      padding: 60px 20px;
      text-align: center;
      background: #0f171b;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 30px;
    }
    
    .upload-area.dragover {
      border-color: var(--orange);
      background: rgba(250, 70, 22, 0.05);
    }
    
    .upload-area.uploading {
      border-color: var(--teal);
      background: rgba(11, 162, 179, 0.05);
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    
    .upload-text {
      font-size: 1.2rem;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .upload-subtext {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .file-input {
      display: none;
    }
    
    .btn {
      background: var(--orange);
      color: var(--white);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      margin: 20px 10px 0 10px;
      transition: background 0.2s ease;
    }
    
    .btn:hover {
      background: #E63E0F;
    }
    
    .btn:disabled {
      background: #3C464B;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .progress-section {
      display: none;
      margin-top: 30px;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #3C464B;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--teal));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .progress-details {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .result-section {
      display: none;
      margin-top: 30px;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1b262d;
    }
    
    .result-success {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
    }
    
    .result-error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .result-title {
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }
    
    .result-details {
      margin-bottom: 16px;
    }
    
    .download-links {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .download-link {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--deep-blue-2);
      color: var(--white);
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }
    
    .download-link:hover {
      background: #3C464B;
    }
    
    .info-section {
      margin-top: 40px;
      padding: 20px;
      background: #0f171b;
      border-radius: 12px;
      border: 1px solid #1b262d;
    }
    
    .info-title {
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--orange);
    }
    
    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .info-list li {
      padding: 4px 0;
      color: var(--muted);
    }
    
    .info-list li::before {
      content: "‚úì ";
      color: var(--success);
      font-weight: bold;
      margin-right: 8px;
    }
    
    .token-section {
      margin-top: 30px;
      padding: 20px;
      background: rgba(250, 70, 22, 0.05);
      border: 1px solid rgba(250, 70, 22, 0.2);
      border-radius: 12px;
    }
    
    .token-input {
      width: 100%;
      padding: 12px;
      background: var(--deep-blue-2);
      border: 1px solid #3C464B;
      border-radius: 8px;
      color: var(--white);
      font-size: 0.9rem;
      margin-top: 8px;
    }
    
    .token-help {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 8px;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 20px 16px;
      }
      
      .upload-area {
        padding: 40px 16px;
      }
      
      .download-links {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ FUSION Agenda Upload</h1>
      <p>Upload your Excel file to automatically generate the agenda JSON</p>
    </div>
    
    <div class="token-section">
      <div class="info-title">GitHub Access Token (Required)</div>
      <input type="password" id="githubToken" class="token-input" placeholder="Enter your GitHub personal access token">
      <div class="token-help">
        Need a token? <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--orange);">Create one here</a> 
        with "Contents" write permission for the repository.
      </div>
    </div>
    
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Drag & drop your Excel file here</div>
      <div class="upload-subtext">or click to browse (agenda.xlsx files only)</div>
      <button type="button" class="btn" onclick="document.getElementById('fileInput').click()">
        Choose File
      </button>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
    </div>
    
    <div class="progress-section" id="progressSection">
      <div class="progress-text" id="progressText">Uploading file...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-details" id="progressDetails">Please wait while we process your file</div>
    </div>
    
    <div class="result-section" id="resultSection">
      <div class="result-title" id="resultTitle">Upload Complete!</div>
      <div class="result-details" id="resultDetails">
        Your Excel file has been processed successfully.
      </div>
      <div class="download-links" id="downloadLinks">
        <!-- Download links will be populated here -->
      </div>
    </div>
    
    <div class="info-section">
      <div class="info-title">How it works</div>
      <ul class="info-list">
        <li>Upload your Excel file with the "Agenda" sheet</li>
        <li>File is automatically processed and converted to JSON</li>
        <li>GitHub Actions workflow generates the agenda.json</li>
        <li>Your live website updates within 5-10 minutes</li>
        <li>Download the generated JSON or view the workflow status</li>
      </ul>
    </div>
  </div>

  <script>
    // Configuration
    const REPO_OWNER = 'uipathlabs-dev';
    const REPO_NAME = 'fusion-agenda';
    const BRANCH = 'main';
    
    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const progressSection = document.getElementById('progressSection');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const progressDetails = document.getElementById('progressDetails');
    const resultSection = document.getElementById('resultSection');
    const resultTitle = document.getElementById('resultTitle');
    const resultDetails = document.getElementById('resultDetails');
    const downloadLinks = document.getElementById('downloadLinks');
    const tokenInput = document.getElementById('githubToken');
    
    // State
    let isUploading = false;
    
    // Event listeners
    uploadArea.addEventListener('click', () => {
      if (!isUploading) {
        fileInput.click();
      }
    });
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });
    
    // File handling
    function handleFileSelect(file) {
      if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
        showError('Please select an Excel file (.xlsx or .xls)');
        return;
      }
      
      if (!tokenInput.value.trim()) {
        showError('Please enter your GitHub access token first');
        tokenInput.focus();
        return;
      }
      
      uploadFile(file);
    }
    
    // Upload functionality
    async function uploadFile(file) {
      if (isUploading) return;
      
      isUploading = true;
      uploadArea.classList.add('uploading');
      showProgress('Preparing upload...', 10);
      
      try {
        // Convert file to base64
        const base64Content = await fileToBase64(file);
        showProgress('Uploading to GitHub...', 30);
        
        // Upload to GitHub
        const response = await uploadToGitHub(file.name, base64Content, tokenInput.value.trim());
        showProgress('Processing file...', 60);
        
        // Monitor workflow
        await monitorWorkflow(response.commit.sha);
        showProgress('Complete!', 100);
        
        showSuccess(response);
        
      } catch (error) {
        console.error('Upload error:', error);
        showError(error.message || 'Upload failed. Please try again.');
      } finally {
        isUploading = false;
        uploadArea.classList.remove('uploading');
      }
    }
    
    // GitHub API functions
    async function uploadToGitHub(filename, base64Content, token) {
      const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/${filename}`;
      
      // First, try to get the current file to get its SHA
      let currentSha = null;
      try {
        const currentResponse = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (currentResponse.ok) {
          const currentData = await currentResponse.json();
          currentSha = currentData.sha;
        }
      } catch (e) {
        // File doesn't exist, which is fine
      }
      
      // Upload the file
      const uploadData = {
        message: `Update agenda Excel file via web upload\\n\\nüìä Uploaded: ${filename}\\nüìÖ Time: ${new Date().toISOString()}`,
        content: base64Content,
        branch: BRANCH
      };
      
      if (currentSha) {
        uploadData.sha = currentSha;
      }
      
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(uploadData)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
      }
      
      return response.json();
    }
    
    async function monitorWorkflow(commitSha) {
      const maxAttempts = 30; // 5 minutes max
      let attempts = 0;
      
      while (attempts < maxAttempts) {
        try {
          const runsResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?head_sha=${commitSha}`, {
            headers: {
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (runsResponse.ok) {
            const runsData = await runsResponse.json();
            const run = runsData.workflow_runs.find(r => r.head_sha === commitSha);
            
            if (run) {
              if (run.status === 'completed') {
                if (run.conclusion === 'success') {
                  return run;
                } else {
                  throw new Error(`Workflow failed: ${run.conclusion}`);
                }
              }
              
              showProgress(`Workflow ${run.status}...`, 70 + (attempts * 2));
            }
          }
        } catch (error) {
          console.warn('Workflow monitoring error:', error);
        }
        
        attempts++;
        await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
      }
      
      throw new Error('Workflow monitoring timeout. Check the Actions tab manually.');
    }
    
    // Utility functions
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }
    
    // UI functions
    function showProgress(text, percentage) {
      progressSection.style.display = 'block';
      resultSection.style.display = 'none';
      
      progressText.textContent = text;
      progressFill.style.width = `${Math.min(percentage, 100)}%`;
      
      if (percentage < 100) {
        progressDetails.textContent = 'This may take a few minutes...';
      } else {
        progressDetails.textContent = 'Processing complete!';
      }
    }
    
    function showSuccess(response) {
      progressSection.style.display = 'none';
      resultSection.style.display = 'block';
      resultSection.className = 'result-section result-success';
      
      resultTitle.textContent = '‚úÖ Upload Successful!';
      resultDetails.innerHTML = `
        <strong>File uploaded:</strong> ${response.content.name}<br>
        <strong>Commit:</strong> ${response.commit.sha.substring(0, 7)}<br>
        <strong>Status:</strong> Processing in background...
      `;
      
      downloadLinks.innerHTML = `
        <a href="https://github.com/${REPO_OWNER}/${REPO_NAME}/actions" class="download-link" target="_blank">
          üîÑ View Workflow Status
        </a>
        <a href="https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/agenda.json" class="download-link" target="_blank">
          üìÑ View Generated JSON
        </a>
        <a href="https://${REPO_OWNER}.github.io/${REPO_NAME}/" class="download-link" target="_blank">
          üåê View Live Site
        </a>
      `;
    }
    
    function showError(message) {
      progressSection.style.display = 'none';
      resultSection.style.display = 'block';
      resultSection.className = 'result-section result-error';
      
      resultTitle.textContent = '‚ùå Upload Failed';
      resultDetails.textContent = message;
      downloadLinks.innerHTML = `
        <a href="https://github.com/settings/tokens" class="download-link" target="_blank">
          üîë Create Access Token
        </a>
      `;
    }
  </script>
</body>
</html>